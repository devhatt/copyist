<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Drag and Drop Texts with Hover on Canvas</title>
    <style>
      canvas {
        border: 1px solid black;
      }
    </style>
  </head>
  <body>
    <a href="./other-test.html">AHEU</a>
    <input type="text" id="textInput" placeholder="Enter text" />
    <button onclick="addText()">Add Text</button>
    <canvas id="myCanvas" width="500" height="500"></canvas>
    <input type="file" id="imageInput" accept="image/*" />
    <button onclick="exportCanvas()">Export Canvas</button>

    <script>
      const canvas = document.getElementById("myCanvas");
      const ctx = canvas.getContext("2d");
      const texts = [];
      let selectedTextIndex = -1;
      let hoverTextIndex = -1;
      let offsetX, offsetY;
      let img = null;

      document
        .getElementById("imageInput")
        .addEventListener("change", function (event) {
          const file = event.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function (evt) {
              img = new Image();
              img.onload = function () {
                const canvas = document.getElementById("myCanvas");
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext("2d");
                ctx.drawImage(img, 0, 0);
              };
              img.src = evt.target.result;
            };
            reader.readAsDataURL(file);
          }
        });

      function addText() {
        const input = document.getElementById("textInput");
        if (input.value.trim() !== "") {
          texts.push({ text: input.value, x: 50, y: 50 });
          input.value = "";
          redrawCanvas();
        }
      }

      canvas.addEventListener("mousedown", function (e) {
        const [mouseX, mouseY] = getMousePos(canvas, e);
        selectedTextIndex = findTextIndex(mouseX, mouseY);
        hoverTextIndex = selectedTextIndex; // Mantém o efeito de hover ao iniciar o arraste
        if (selectedTextIndex !== -1) {
          offsetX = mouseX - texts[selectedTextIndex].x;
          offsetY = mouseY - texts[selectedTextIndex].y;
        }
      });

      canvas.addEventListener("mousemove", function (e) {
        const [mouseX, mouseY] = getMousePos(canvas, e);
        if (selectedTextIndex === -1) {
          hoverTextIndex = findTextIndex(mouseX, mouseY);
        }
        if (selectedTextIndex !== -1) {
          texts[selectedTextIndex].x = mouseX - offsetX;
          texts[selectedTextIndex].y = mouseY - offsetY;
        }
        redrawCanvas();
      });

      canvas.addEventListener("mouseup", function (e) {
        selectedTextIndex = -1;
        hoverTextIndex = -1; // Remove o efeito de hover ao soltar
        redrawCanvas();
      });

      function redrawCanvas() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0);
        texts.forEach((textObj, index) => {
          drawText(
            ctx,
            textObj.text,
            textObj.x,
            textObj.y,
            index === hoverTextIndex
          );
        });
      }
      function drawText(ctx, text, x, y) {
        let currentX = x;
        let bold = false;
        let italic = false;
        let code = false;
        let word = "";
        ctx.font = "34px Arial";

        for (let i = 0; i < text.length; i++) {
          let char = text[i];

          // Verifica se encontrou um caractere especial
          if (
            char === "`" ||
            (char === "*" && text[i + 1] === "*") ||
            (char === "_" && text[i + 1] === "_")
          ) {
            // Desenha a palavra atual antes de alternar o estilo
            if (word !== "") {
              drawWord(ctx, word, currentX, y, code);
              currentX += ctx.measureText(word).width;
              word = "";
            }

            if (char === "`") {
              code = !code; // Alterna o estado de código
            } else if (char === "*") {
              bold = !bold; // Alterna o estado de negrito
            } else {
              italic = !italic; // Alterna o estado de itálico
            }

            // Define o estilo da fonte
            ctx.font = getCodeFont(bold, italic, code);
            i += char !== "`" ? 1 : 0; // Pula o próximo caractere especial se não for `
          } else {
            word += char;

            // Verifica se é o fim da palavra ou da string
            if (char === " " || i === text.length - 1) {
              drawWord(ctx, word, currentX, y, code);
              currentX += ctx.measureText(word).width;
              word = "";
            }
          }
        }
      }

      function drawWord(ctx, word, x, y, isCode) {
        if (isCode) {
          const metrics = ctx.measureText(word);
          ctx.fillStyle = "lightgrey"; // Cor de fundo para código
          ctx.fillRect(
            x - 2,
            y - metrics.actualBoundingBoxAscent - 2,
            metrics.width + 4,
            metrics.actualBoundingBoxAscent +
              metrics.actualBoundingBoxDescent +
              4
          );
          ctx.fillStyle = "black"; // Cor do texto
        }
        ctx.fillText(word, x, y);
        ctx.fillStyle = "black"; // Resetar cor do texto para preto
      }

      function getCodeFont(bold, italic, code) {
        let style = "";
        if (code) {
          style = "21px Courier New"; // Fonte para estilo de código
        } else {
          style =
            (bold ? "bold " : "") + (italic ? "italic " : "") + "34px Arial";
        }
        return style;
      }

      function getMousePos(canvas, evt) {
        const rect = canvas.getBoundingClientRect();
        return [evt.clientX - rect.left, evt.clientY - rect.top];
      }

      function findTextIndex(x, y) {
        for (let i = 0; i < texts.length; i++) {
          const textObj = texts[i];
          if (
            x >= textObj.x - 21 &&
            x <= textObj.x + ctx.measureText(textObj.text).width + 21 &&
            y >= textObj.y - 21 &&
            y <= textObj.y + 9
          ) {
            return i;
          }
        }
        return -1;
      }

      function exportCanvas() {
        if (!img) {
          alert("Please upload an image first.");
          return;
        }
        const image = canvas
          .toDataURL("image/png")
          .replace("image/png", "image/octet-stream");
        const link = document.createElement("a");
        link.download = "canvas-image.png";
        link.href = image;
        link.click();
      }
    </script>
  </body>
</html>
